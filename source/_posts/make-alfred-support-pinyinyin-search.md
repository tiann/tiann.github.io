title: è®©Alfredæ”¯æŒæ‹¼éŸ³æœç´¢
date: 2015-12-07 04:39:49
tags:
- alfred
- python
---

Alfredæ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œä¸è¿‡æ£€ç´¢ç¨‹åºçš„æ—¶å€™ä¸æ”¯æŒæ‹¼éŸ³æœç´¢ï¼›æˆ‘åœ¨è®ºå›çœ‹åˆ°æœ‰äººç»™ä½œè€…åé¦ˆè¿‡ï¼Œæ— å¥ˆä½œè€…è¯´æ”¯æŒä¸­æ–‡ï¼Œä»–ä¸çŸ¥é“æ‹¼éŸ³æ˜¯ä»€ä¹ˆï¼Œäºæ˜¯å°±ä¸äº†äº†ä¹‹äº†ã€‚ä¸¾ä¸ªä¾‹å­ï¼šæˆ‘æƒ³æ‰“å¼€`ç½‘æ˜“äº‘éŸ³ä¹`,å¯æ˜¯å½“æˆ‘è¾“å…¥`wangyiyunyinyue`çš„æ—¶å€™å´æ˜¯è¿™æ ·çš„ç»“æœ:

<img src="http://weishu1.dimensionalzone.com/test/1449431593204.png" width="536" alt="ä¸æ”¯æŒæ‹¼éŸ³çš„æœç´¢ç»“æœ"/>

è¦ä¹ˆæˆ‘çŸ¥é“è¿™ä¸ªAppçš„åå­—å«åš`NeteaseMusic`ï¼Œè¦ä¹ˆæˆ‘å°±éœ€è¦ç”¨ä¸­æ–‡è¾“å…¥`ç½‘æ˜“äº‘éŸ³ä¹`æ‰“å¼€äº†ï¼›å¦‚æœæ°å·§è¾“å…¥æ³•æ˜¯è‹±æ–‡è¾“å…¥çŠ¶æ€ï¼Œé‚£ä¹ˆå°±ä¼šé‡åˆ°ä¸Šå›¾çš„æƒ…å†µï¼›è¿™æ—¶å€™å†æŠŠå·²ç»è¾“å…¥çš„åˆ é™¤ç„¶ååˆ‡æ¢è¾“å…¥æ³•æ‰“å¼€ï¼Œæ•ˆç‡æ— ç–‘å¤§å¤§æŠ˜æ‰£ã€‚

<!-- more -->
å°±ç®—è¿™é‡Œæœç´¢è¿™ä¸ªAppå¯ä»¥ä½¿ç”¨è‹±æ–‡åå­—è§£å†³ï¼Œå¯æ˜¯å¯¹äºæŸäº›ç³»ç»Ÿç¨‹åºæ¯”å¦‚é‚®ä»¶å¯èƒ½è¿˜çŸ¥é“æ˜¯`Mail`ï¼Œé‚£ä¹ˆå¤‡å¿˜å½•å‘¢ï¼Ÿä¾¿ç­¾å‘¢ï¼Ÿè¿˜æœ‰ä¸€äº›åˆ«çš„ä¸­æ–‡ç¨‹åºæ²¡æœ‰è‹±æ–‡åçš„æ¯”å¦‚é©¬å…‹é£è±¡ï¼Ÿå¦‚æœAlfredèƒ½æ”¯æŒæ‹¼éŸ³æœç´¢ï¼Œè¿™äº›é—®é¢˜å…¨éƒ¨éƒ½æ²¡äº†ï¼è€Œä¸”ï¼ŒAlfredå¯ä»¥å¼ºåˆ¶ä½¿ç”¨è‹±æ–‡è¾“å…¥ï¼Œç›´æ¥ä½¿ç”¨å­—æ¯æ£€ç´¢ï¼Œä¸ç”¨åˆ‡æ¢è¾“å…¥æ³•äº†ã€‚

## åŸç†
ç»è¿‡ç®€å•çš„è§‚å¯Ÿä¹‹åï¼Œå‘ç°Alfredæ£€ç´¢ç¨‹åºä¸ä»…ä»…æ˜¯æ£€ç´¢åå­—ï¼Œè¿˜æ”¶é›†äº†ä¸€äº›é¢å¤–çš„ä¿¡æ¯ï¼›åœ¨Alfredä½œè€…çš„å¸®åŠ©ä¸‹ï¼ŒçŸ¥é“å®ƒåˆ©ç”¨äº†Macæ–‡ä»¶ç³»ç»Ÿçš„ä¸€ä¸ª**æ‹“å±•ä¿¡æ¯**çš„å­—æ®µï¼›å¦‚æœä½ å‘ç°æŸäº›ç›®å½•åé¢æœ‰`@`é‚£ä¹ˆå°±æ˜¯æœ‰æ‹“å±•ä¿¡æ¯äº†ï¼š

```
drwxr-xr-x+  3 root    wheel  102  9 10  2014 Stickies.app/
drwxr-xr-x@  3 weishu  admin  102  3 26  2015 Sublime Text.app/
```
å¯ä»¥å€ŸåŠ©å‘½ä»¤è¡Œå·¥å…·`xattr`è¿›è¡Œæ“ä½œï¼›å…·ä½“ä½¿ç”¨å¯ä»¥`man xattr`.

æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡**æŠŠæ‹¼éŸ³ä¿¡æ¯æ·»åŠ åˆ°æ–‡ä»¶çš„æ‹“å±•ä¿¡æ¯é‡Œé¢**å»ï¼Œè¿™æ ·Alfredå°±èƒ½å€ŸåŠ©è¿™äº›ä¿¡æ¯å¸®åŠ©æ‹¼éŸ³æ£€ç´¢äº†ã€‚

## å®ç°

### è·å–ç¨‹åºå
ç¨‹åºåä¸ä»…ä»…æ˜¯ä¸€ä¸ªæ–‡ä»¶åè¿™ä¹ˆç®€å•ï¼ŒMacè½¯ä»¶æœ‰ä¸€ä¸ªå«åš*localization*çš„æ¦‚å¿µï¼Œå¤§è‡´å°±æ˜¯å›½é™…åŒ–å§ï¼›ç¨‹åºç»“æ„æŠŠå›½é™…åŒ–çš„å­—æ®µå­˜æ”¾åœ¨ä¸åŒçš„æ–‡ä»¶é‡Œé¢ï¼Œåœ¨ç¨‹åºæœ¬åœ°åŒ–ä¹‹åè‡ªåŠ¨load.

æˆ‘ä»¬è¦ä½¿ç”¨çš„é‚£ä¸ªå­—æ®µæ˜¯`CFBundleName`å­˜æ”¾åœ¨`/<App>/Contents/Resources/<language>/InfoPlist.strings`è¿™ä¸ªæ–‡ä»¶é‡Œé¢ï¼›æˆ‘ä»¬æŠŠè¿™ä¸ªåå­—è¯»å–å‡ºæ¥å³å¯ã€‚

å°è¯•è¿‡ä½¿ç”¨`objc`çš„æ¥å£`NSBundle.localizedInfoDiction`æ¥è·å–æœ¬åœ°åŒ–çš„å­—æ®µï¼Œæ— å¥ˆæ‹¿åˆ°çš„æ°¸è¿œæ˜¯è‹±æ–‡å­—æ®µï¼›åªå¥½æ‰‹å·¥è§£æä¸­æ–‡å­—æ®µäº†ï¼ˆä¸ä¼šObjc ğŸ˜­ï¼‰ï¼›ä½¿ç”¨çš„å‘½ä»¤è¡Œå·¥å…·`plutil`:

```python
def _get_localized_name(abs_path):
    '''get the localized name of given app'''
    bundle = NSBundle.new()
    bundle.initWithPath_(abs_path)
    localizations = bundle.localizations()
    chinese = ('zh_CN', 'zh_Hans')

    b = any(map(lambda x: x in localizations, chinese))
    if not b: return 

    for ch in chinese:
        path = bundle.pathForResource_ofType_inDirectory_forLanguage_('InfoPlist', 'strings', None, ch)
        if not path: continue
        # the path must surround with "", there may be space characters
        json_str = subprocess.check_output(u'plutil -convert json -o - "%s"' % path, shell=True)
        # print json_str
        json_res = json.loads(json_str, encoding='utf8')
        name = json_res.get('CFBundleName')
        if name: return name
```
### è½¬æ¢ä¸ºæ‹¼éŸ³
å¯ä»¥ç›´æ¥ä½¿ç”¨pythonçš„æ‹¼éŸ³è½¬æ¢åº“[pypinyin][1],å€ŸåŠ©è¿™ä¸ªå·¥å…·ï¼Œä¸€è¡Œä»£ç æå®šï¼š

```python
def _get_app_pinyin_name(app_name):
    reduce(lambda x, y: x + y, lazy_pinyin(app_name, errors='ignore'))
```
### æ·»åŠ æ‹¼éŸ³ä¿¡æ¯
æ‹¼éŸ³ä¿¡æ¯è¢«æ·»åŠ åˆ°æ–‡ä»¶çš„æ‹“å±•ä¿¡æ¯é‡Œé¢ï¼Œç›´æ¥ä½¿ç”¨`xattr`æ·»åŠ å³å¯ï¼š

```python
def _add_meta_data(app_pinyin_name, app_path):
    ''' add meta data(comments) to the app, which can help Alfred or SpotLight find it'''
    subprocess.check_call('xattr -w com.apple.metadata:kMDItemFinderComment %s %s' % (app_pinyin_name, app_path), shell=True)
```

å¥½äº†ï¼ŒæŠŠè¿™äº›ä»£ç æ•´åˆèµ·æ¥ï¼Œå°±èƒ½å¾—åˆ°æœ€ç»ˆçš„ç»“æœäº†ï¼Œå®Œæ•´çš„ä»£ç åœ¨[è¿™é‡Œ][2]ã€‚

```python
def main():
    pattern = re.compile(r'^[\w\s.]+$')

    workspace = NSWorkspace.sharedWorkspace()

    for app_dir in APP_DIRECTORYS:
        if not os.path.exists(app_dir): continue

        for root, dirs, files in os.walk(app_dir, topdown=True):
            remove_list = []
            for directory in dirs:
                # print type(directory), root, directory
                full_path = os.path.join(root, directory)
                if not _is_application(workspace, full_path): continue

                remove_list.append(directory)
                
                localized_name =  _get_localized_name(full_path)
                app_name = localized_name if localized_name else directory.rsplit(r'.')[0]

                if pattern.match(app_name): 
                    continue
                
                _add_meta_data(_get_app_pinyin_name(app_name), full_path)

            # if this directory is already a Application
            # do not traverse this; some app may be very large 
            # and there won't be any other app inside it
            dirs[:] = [d for d in dirs if d not in remove_list]
```

æœ€åï¼Œæˆ‘ä»¬æ‰§è¡Œè¿™ä¸€æ®µè„šæœ¬å³å¯`sudo python main.py`ã€‚ä¹‹æ‰€ä»¥éœ€è¦**sudo**æ˜¯å› ä¸ºæŸäº›ç³»ç»Ÿç¨‹åºï¼ˆæ¯”å¦‚å®¶è®¡ç®—å™¨ï¼‰ï¼Œç›´æ¥ä½¿ç”¨æ˜¯æ²¡æœ‰æƒé™çš„ã€‚

æœ€åçœ‹æ•ˆæœï¼š

<img src="http://weishu1.dimensionalzone.com/markdownalfredpinyin.gif" width="1104" alt="æ”¯æŒæ‹¼éŸ³æœç´¢æ•ˆæœå›¾"/>
[1]: https://github.com/mozillazg/python-pinyin
[2]: https://gist.github.com/tiann/35fb758c18036d7f8640